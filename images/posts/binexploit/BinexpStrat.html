<html><head><meta content="text/html; charset=UTF-8" http-equiv="content-type"><style type="text/css">@import url('https://themes.googleusercontent.com/fonts/css?kit=pYEwJuzr3ZMDX2Y1syVbvyys90xk6yC7BGUgJrNTTF0');ol{margin:0;padding:0}table td,table th{padding:0}.c12{padding-top:0pt;text-indent:36pt;padding-bottom:12pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c23{padding-top:0pt;padding-bottom:3pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:center}.c15{padding-top:18pt;padding-bottom:6pt;line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:center}.c19{padding-top:0pt;padding-bottom:12pt;line-height:1.0;orphans:2;widows:2;text-align:left}.c18{padding-top:0pt;padding-bottom:12pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c6{padding-top:0pt;padding-bottom:12pt;line-height:1.15;orphans:2;widows:2;text-align:center}.c0{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:center}.c10{padding-top:0pt;padding-bottom:0pt;line-height:1.15;orphans:2;widows:2;text-align:left}.c7{color:#000000;text-decoration:none;vertical-align:baseline;font-size:11pt;font-style:normal}.c14{font-size:9pt;font-family:"Consolas";color:#660066;font-weight:400}.c9{font-size:9pt;font-family:"Consolas";color:#000088;font-weight:400}.c5{font-size:9pt;font-family:"Consolas";color:#666600;font-weight:400}.c25{color:#000000;font-weight:400;font-size:26pt;font-family:"Ubuntu"}.c20{-webkit-text-decoration-skip:none;color:#1155cc;text-decoration:underline;text-decoration-skip-ink:none}.c13{font-size:9pt;font-family:"Consolas";color:#006666;font-weight:400}.c3{font-size:9pt;font-family:"Consolas";color:#000000;font-weight:400}.c16{color:#000000;font-weight:400;font-size:16pt;font-family:"Arial"}.c8{text-decoration:none;vertical-align:baseline;font-style:normal}.c21{background-color:#ffffff;max-width:468pt;padding:72pt 72pt 72pt 72pt}.c2{font-weight:400;font-family:"Times New Roman"}.c1{color:inherit;text-decoration:inherit}.c22{color:#000000;font-size:16pt}.c17{font-weight:400;font-family:"Arial"}.c24{font-weight:700;font-family:"Times New Roman"}.c11{font-style:italic}.c4{height:11pt}.title{padding-top:0pt;color:#000000;font-size:26pt;padding-bottom:3pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}.subtitle{padding-top:0pt;color:#666666;font-size:15pt;padding-bottom:16pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}li{color:#000000;font-size:11pt;font-family:"Arial"}p{margin:0;color:#000000;font-size:11pt;font-family:"Arial"}h1{padding-top:20pt;color:#000000;font-size:20pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h2{padding-top:18pt;color:#000000;font-size:16pt;padding-bottom:6pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h3{padding-top:16pt;color:#434343;font-size:14pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h4{padding-top:14pt;color:#666666;font-size:12pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h5{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;orphans:2;widows:2;text-align:left}h6{padding-top:12pt;color:#666666;font-size:11pt;padding-bottom:4pt;font-family:"Arial";line-height:1.15;page-break-after:avoid;font-style:italic;orphans:2;widows:2;text-align:left}</style></head><body class="c21"><p class="c23 title" id="h.syskeaah2h5v"><span class="c8 c25">Strategies for Binary Exploitation</span></p><p class="c10 c4"><span class="c7 c17"></span></p><p class="c0"><span class="c2">When it comes to breaking compiled applications an adversary&rsquo;s best tools are his knowledge of binary exploitation and reverse engineering. &nbsp;But these tools take an incredible amount of time to build and oftentimes newcomers to the field are deterred by the complexity of the subject. &nbsp;This post will serve as an introduction to the strategies that I discovered over my brief time with working in binary exploitation. &nbsp;Additionally I will be covering the applications of some of the tools that I use including Binary Ninja for decompiling, python for scripting clever solutions, and the l</span><span class="c2">inux command line for typical interactions.</span><span class="c24">&nbsp; </span><span class="c2">In this post I will use challenges based on the popular wargame </span><span class="c2 c11">pwnable.kr </span><span class="c7 c2">to dive deep into the strategies behind binary exploitation and provide the deepest level of understanding in regards to the mechanisms that dictate each challenge.</span></p><h2 class="c15" id="h.g1hwgzqqz8ln"><span class="c8 c2 c22">Memory Corruption</span></h2><p class="c0"><span class="c7 c2">A wide variety of system level exploits found in the wild use the concept of memory corruption to modify the memory of a running executable in a way that it is not intended for. &nbsp;Memory corruption is directly associated and introduced with the classic buffer overflow vulnerability which has tainted the lives of developers for decades.When searching for this vulnerability it is best to look for a location where user input is being copied directly to a buffer without any form of sanitization or length validation. &nbsp;Given this information we must now fully understand how the stack works so we can exploit our first binary.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 481.00px; height: 471.00px;"><img alt="" src="images/image15.jpg" style="width: 481.00px; height: 471.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">This diagram focuses on the development of the stack when a function is called. &nbsp;At the beginning we notice that the parameters are pushed onto the stack in reverse order. &nbsp;Next the address which the program should return to is pushed onto the stack. &nbsp;For example, a main function calls the </span><span class="c2 c11">foo</span><span class="c2">&nbsp;function on line 10 of some arbitrary &nbsp;c code. &nbsp;An address to this specific line in the code is used as a reference for </span><span class="c2 c11">foo</span><span class="c7 c2">&nbsp;to return to when it is complete. &nbsp;Next to be pushed onto the stack are the local variables for the function followed by our target buffer. &nbsp;For this particular exploit we are going to want to fill the buffer to its maximum capacity and then continue further until we get to the exact location of the value or address which we want to overwrite.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c2">The best place to begin searching for this buffer overflow vulnerability is going to be with a disassembled binary. &nbsp;Throughout the rest of this post we will be using Binary Ninja as our disassembler however many other options also exist such as IDA or even the </span><span class="c2 c11">disas</span><span class="c7 c2">&nbsp;command in gdb.</span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 534.00px; height: 245.00px;"><img alt="" src="images/image11.png" style="width: 534.00px; height: 245.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c10"><span class="c2">In this image we see the disassembled main function which is essentially just pushing </span><span class="c2 c11">0xdeadbeef </span><span class="c2">onto the stack as a parameter for the function call </span><span class="c2 c11">func. &nbsp;</span><span class="c7 c2">At this point I have found that the best course of action is to try to rebuild the source code for the binary that we are disassembling in c to better understand exactly what is going on. &nbsp;So the main function will look something like the following:</span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c14">int</span><span class="c3">&nbsp;main</span><span class="c5">(){</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;func</span><span class="c5">(</span><span class="c13">0xdeadbeef</span><span class="c5">);</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c9">return</span><span class="c3">&nbsp;</span><span class="c13">0;</span></p><p class="c10"><span class="c3">}</span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c2">Now let&rsquo;s look at the </span><span class="c2 c11">func</span><span class="c7 c2">&nbsp;function.</span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 696.50px; height: 416.00px;"><img alt="" src="images/image17.png" style="width: 696.50px; height: 416.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c7 c2">The most important line here is:</span></p><p class="c10"><span class="c2">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c10"><span class="c3 c8">0x643&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;lea&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;eax, [ebp-0x2c] {var_30}</span></p><p class="c10 c4"><span class="c3 c8"></span></p><p class="c10"><span class="c2">The first line indicates the allocation of space starting at the base pointer (ebp) and moving down 0x2c bytes or in decimal 44 bytes. &nbsp;The assembly also reveals that user input is taken directly from </span><span class="c2 c11">gets</span><span class="c2">&nbsp;and put into the buffer. &nbsp;The contents of this buffer is essentially worthless as the first parameter </span><span class="c2 c11">0xdeadbeef</span><span class="c2">&nbsp;is compared to the constant </span><span class="c2 c11">0xcafebabe. </span><span class="c7 c2">Depending on the result of the comparison either a &ldquo;Nah&hellip;&rdquo; is displayed if the buffer is not the same, or a shell is return if they are the same. &nbsp;The code for this is as follows:</span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c14">Void</span><span class="c3">&nbsp;func</span><span class="c5">(</span><span class="c9">int</span><span class="c3">&nbsp;constant</span><span class="c5">){</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c14">char</span><span class="c3">&nbsp;buffer</span><span class="c5">[</span><span class="c13">32</span><span class="c5">];</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="c5">(&quot;</span><span class="c14">Overflow</span><span class="c3">&nbsp;me </span><span class="c5">:</span><span class="c3">&nbsp;</span><span class="c5">&quot;);</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;gets</span><span class="c5">(</span><span class="c3">buffer</span><span class="c5">);</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c9">if</span><span class="c5">(</span><span class="c3">constant </span><span class="c5">!=</span><span class="c3">&nbsp;</span><span class="c13">0xcafebabe</span><span class="c5">){</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="c5">(&quot;</span><span class="c14">Nah</span><span class="c5">..&quot;);</span></p><p class="c10"><span class="c3 c8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c14">else{</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;system</span><span class="c5">(&quot;/</span><span class="c3">bin</span><span class="c5">/</span><span class="c3">sh</span><span class="c5">&quot;);</span></p><p class="c10"><span class="c3 c8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c10"><span class="c3 c8">}</span></p><p class="c10 c4"><span class="c3 c8"></span></p><p class="c10"><span class="c7 c2">Now it is just a matter of discovering the correct number of bytes we need to flood in order to overflow the buffer with the value that we desire. &nbsp;On the stack we allocated a space of 44 bytes immediately after the parameters and return address were pushed on the stack. &nbsp;The parameter and the return address take up 4 bytes each for a total of 8 bytes of distance between the value we wish to overwrite and the buffer. &nbsp;This means that if we manipulate the buffer to travel 52 bytes up the stack we will reach the location of the parameters and replace it with whatever we want. &nbsp;The final aspect that we must take in consideration is the endianness of the computer. &nbsp;In this case the computer is little endian so we need to feed the desired value in reverse order. (\xbe\xba\xfe\xca = 0xcafebabe) The easiest way to generate 52 bytes of trash is to use python and then append the desired value onto the input.</span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c3">python </span><span class="c5">-</span><span class="c3">c </span><span class="c5">&quot;</span><span class="c9">print</span><span class="c3">&nbsp;</span><span class="c13">52</span><span class="c5">*&#39;</span><span class="c3">A</span><span class="c5">&#39;</span><span class="c3">&nbsp;</span><span class="c5">+</span><span class="c3">&nbsp;</span><span class="c5">&#39;</span><span class="c3">\xbe\xba\xfe\xca</span><span class="c5">&#39;&quot;;</span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c7 c2">This process reveals a vital strategy which is to develop of full understanding of all elements that are subject to the particular exploit you are engaging in. &nbsp;Oftentimes I found myself ignoring vital components of the x86 syntax or even fundamentals of the stack which lead me down a dangerous path of frustration and wasting time. &nbsp;It is best to develop a malleable plan and then break the overall problem down into much smaller parts. &nbsp;This includes keeping track of the code that you have reverse engineered by forward engineering it from the assembly. &nbsp;This will allow you to determine if your intuitions are correct while also giving you a platform to find patterns and spot suspicious interactions.</span></p><p class="c10 c4"><span class="c2 c7"></span></p><h2 class="c15" id="h.kqedl28do2ms"><span class="c16 c8">Use After Free</span></h2><p class="c0"><span class="c2">One of my favorite challenges from the </span><span class="c2 c11">pwnable.kr</span><span class="c2">&nbsp;wargame is </span><span class="c2 c11">Dragon</span><span class="c7 c2">, a small text based RPG game which contains some interesting hidden functionality. &nbsp;During the game you are given the option of playing a Priest or Knight who both have different abilities. &nbsp;</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 558.00px; height: 636.00px;"><img alt="" src="images/image12.png" style="width: 558.00px; height: 636.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">In both scenarios it is impossible to defeat the </span><span class="c2 c11">Dragon</span><span class="c2">&nbsp;but before we dive into the application it is important to discuss some of the defenses that are put in place to protect binaries from exploitation. &nbsp;The first of these protection is ASLR which is Address Space Layout Randomization. &nbsp;This protection is used to randomly offset the location of modules and memory based structures to prevent shellcode execution. &nbsp;This is incredibly effective at mitigating some buffer overflow exploits as an adversary is no longer able to reliably jump to a vulnerable function in memory. &nbsp;The keyword here is </span><span class="c2 c11">reliably</span><span class="c7 c2">&nbsp;since ASLR still allows the adversary to guess the locations of these randomly placed areas. &nbsp;To prevent against this a high amount of entropy should be used to generate more random offsets. &nbsp;The next defense that is important to us is DEP or Data Execution Protection. &nbsp;This defense is used to mark certain regions of memory sectors such as the stack as being non-executable. &nbsp;This means that if we wanted to inject shellcode into a vulnerable location within a marked sector it will be unsuccessful in executing. &nbsp;Now we notice that both DEP and ASLR is enabled on the system that is running the challenge application so we must keep this in mind when we are searching for a vulnerability. &nbsp;With this out of the way let&rsquo;s begin reverse engineering the application.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 426.67px;"><img alt="" src="images/image13.png" style="width: 624.00px; height: 426.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">When you open an ELF binary in Binary Ninja you are immersed into an environment that allows you to navigate the binary in an organized and intuitive manner. &nbsp;The first function that you enter is called </span><span class="c2 c11">_start</span><span class="c7 c2">&nbsp;and is typically the entry point for the binary. &nbsp;This function is not particularly interesting and is usually used to call the main function. &nbsp;By clicking on either the main function in the left function panel or clicking on the main call in the ELF graph we can navigate to the contents of main. &nbsp;</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 409.33px;"><img alt="" src="images/image8.png" style="width: 624.00px; height: 409.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">Here see that nothing more than a intro banner being displayed and a function call to </span><span class="c2 c11">PlayGame</span><span class="c7 c2">. &nbsp;Just like our last buffer overflow endeavour I strongly recommend documenting the progress we have made by forward engineering the source code. &nbsp;This will appear as follows:</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c19"><span class="c3">main</span><span class="c5">(){</span></p><p class="c19"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;puts</span><span class="c5">(&quot;</span><span class="c14">Welcome</span><span class="c3">&nbsp;to </span><span class="c14">Dragon</span><span class="c3">&nbsp;</span><span class="c14">Hunter</span><span class="c5">!&quot;);</span></p><p class="c19"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c14">PlayGame</span><span class="c5">();</span></p><p class="c19"><span class="c3 c8">}</span></p><p class="c18"><span class="c2">Next we will check out the </span><span class="c2 c11">PlayGame</span><span class="c2">&nbsp;function.</span></p><p class="c6"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 614.67px;"><img alt="" src="images/image10.png" style="width: 624.00px; height: 614.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c6"><span class="c2">The beginning of this function handles the character selection but we discover that by entering 3 we can call the hidden </span><span class="c2 c11">SecretLevel</span><span class="c7 c2">&nbsp;function.</span></p><p class="c6"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 256.00px; height: 149.00px;"><img alt="" src="images/image19.png" style="width: 256.00px; height: 149.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c6"><span class="c7 c2">We find out that we need a password so let&rsquo;s see what we can find in the SecretLevel function.</span></p><p class="c6"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 389.33px;"><img alt="" src="images/image4.png" style="width: 624.00px; height: 389.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c6"><span class="c2">We discover that after entering the correct password we can get a shell, however there appears to be no way we can enter </span><span class="c2 c11">Nice_Try_But_The_Dragons_Won&rsquo;t_Let_You!</span><span class="c2">&nbsp;since we are only creating a space of 0x16 for the</span><span class="c2 c11">&nbsp;scanf</span><span class="c7 c2">&nbsp;function. &nbsp;Let&rsquo;s continue to forward engineer the program with what we have found. &nbsp; </span></p><p class="c18"><span class="c14">Int</span><span class="c3">&nbsp;</span><span class="c14">PlayGame</span><span class="c5">(){</span></p><p class="c12"><span class="c14">Int</span><span class="c3 c8">&nbsp;result;</span></p><p class="c12"><span class="c3">puts</span><span class="c5">(&quot;</span><span class="c14">Choose</span><span class="c3">&nbsp;your </span><span class="c14">Hero</span><span class="c3">\n</span><span class="c5">[</span><span class="c13">1</span><span class="c5">]</span><span class="c3">&nbsp;</span><span class="c14">Priest</span><span class="c3">\n</span><span class="c5">[</span><span class="c13">2</span><span class="c5">]</span><span class="c3">&nbsp;</span><span class="c14">Knight</span><span class="c5">&quot;);</span></p><p class="c12"><span class="c14">Result</span><span class="c3">&nbsp;</span><span class="c5">=</span><span class="c3">&nbsp;</span><span class="c14">GetChoice</span><span class="c5">();</span></p><p class="c12"><span class="c14">If</span><span class="c3">&nbsp;</span><span class="c5">(</span><span class="c3">&nbsp;result </span><span class="c5">==</span><span class="c3">&nbsp;</span><span class="c13">1</span><span class="c3">&nbsp;</span><span class="c5">||</span><span class="c3">&nbsp;result </span><span class="c5">==</span><span class="c3">&nbsp;</span><span class="c13">2</span><span class="c5">){</span></p><p class="c12"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c14">FightDragon</span><span class="c5">(</span><span class="c3">result</span><span class="c5">);</span></p><p class="c12"><span class="c3 c8">}</span></p><p class="c12"><span class="c14">Else</span><span class="c3">&nbsp;</span><span class="c9">if</span><span class="c3">&nbsp;</span><span class="c5">(</span><span class="c3">result </span><span class="c5">==</span><span class="c3">&nbsp;</span><span class="c13">3</span><span class="c5">){</span></p><p class="c12"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c14">SecretLevel</span><span class="c5">();</span></p><p class="c12"><span class="c3 c8">}</span></p><p class="c18"><span class="c3">}</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c10"><span class="c14">Int</span><span class="c3">&nbsp;</span><span class="c14">SecretLevel</span><span class="c5">(){</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c14">Char</span><span class="c3">&nbsp;</span><span class="c9">pass</span><span class="c5">[</span><span class="c13">16</span><span class="c5">];</span></p><p class="c10"><span class="c3 c8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;printf</span><span class="c5">(&quot;</span><span class="c14">Welcome</span><span class="c3">&nbsp;to </span><span class="c14">Secret</span><span class="c3">&nbsp;</span><span class="c14">Level</span><span class="c5">!</span><span class="c3">\n</span><span class="c14">Input</span><span class="c3">&nbsp;</span><span class="c14">Password</span><span class="c3">&nbsp;</span><span class="c5">:</span><span class="c3">&nbsp;</span><span class="c5">&quot;);</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;scanf</span><span class="c5">(%</span><span class="c3">s</span><span class="c5">,</span><span class="c3">&nbsp;</span><span class="c9">pass</span><span class="c5">);</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c9">if</span><span class="c5">(</span><span class="c3">strcmp</span><span class="c5">(</span><span class="c9">pass</span><span class="c5">,</span><span class="c3">&nbsp;</span><span class="c5">&quot;</span><span class="c14">Nice_Try_But_The_Dragons_Won</span><span class="c5">&#39;</span><span class="c3">t_Let_You</span><span class="c5">!&quot;)){</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;puts</span><span class="c5">(&quot;</span><span class="c14">Wrong</span><span class="c5">!</span><span class="c3">\n</span><span class="c5">&quot;)</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span class="c9">exit</span><span class="c5">(</span><span class="c13">1</span><span class="c5">);</span></p><p class="c10"><span class="c3 c8">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;}</span></p><p class="c10"><span class="c3">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;system</span><span class="c5">(&quot;/</span><span class="c3">bin</span><span class="c5">/</span><span class="c3">sh</span><span class="c5">&quot;)</span></p><p class="c10 c4"><span class="c3 c8"></span></p><p class="c10"><span class="c3">}</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">Now it is time to observe the </span><span class="c2 c11">FightDragon</span><span class="c7 c2">&nbsp;function.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 278.67px;"><img alt="" src="images/image2.png" style="width: 624.00px; height: 278.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">Here we notice that two objects are being malloced for at the very beginning. &nbsp;After some digging I noticed that offsets were being used on these objects to retrieve data. &nbsp;Incidentally these objects were associated with either a dragon or the player so using </span><span class="c2 c11">ctrl-n </span><span class="c7 c2">I was able to rename all instances of the variable within Binary Ninja. &nbsp;This is a vital technique as it allows you to easily reference a multitude of variables and thoroughly understand what each of them means.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 280.00px;"><img alt="" src="images/image16.png" style="width: 624.00px; height: 280.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c7 c2">&nbsp;</span></p><p class="c0"><span class="c7 c2">After allocating space for the two structs we notice that there is a counter which is being used to select which dragon the player will fight. &nbsp;After playing the game another time I noticed that after defeating a baby dragon I would be tasked with fighting a mama dragon. &nbsp;This is where we start to notice something very interesting.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 84.00px;"><img alt="" src="images/image3.png" style="width: 624.00px; height: 84.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 220.00px;"><img alt="" src="images/image1.png" style="width: 624.00px; height: 220.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c7 c2">So it appears that the values in the assembly are the stats for the dragon. &nbsp;If we look very closely at the line that I highlighted we can see that only 4 bits were used to store the health of the dragon. &nbsp;This reveals that the absolute maximum health the dragon can have is 127 (1 1 1 1 if all bits are on we get 127 in decimal). &nbsp;With this information I started to speculate if I could instead use the Dragon&rsquo;s health regeneration to overflow the integer and force it to 0. &nbsp;This concept is observed in the following image.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 329.75px; height: 342.50px;"><img alt="" src="images/image9.jpg" style="width: 329.75px; height: 342.50px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c10 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c7 c2">Integers should be thought of as this wheel. &nbsp;If a number is increased to it&rsquo;s maximum it will simply start the cycle all over again. &nbsp;Let&rsquo;s pair the priest&rsquo;s invincibility spell with the Dragon&rsquo;s health regeneration to see if we can make this work. </span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 308.00px;"><img alt="" src="images/image5.png" style="width: 624.00px; height: 308.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c7 c2">We successfully discovered how to defeat the Dragon but we still want our shell. &nbsp;</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 146.67px;"><img alt="" src="images/image6.png" style="width: 624.00px; height: 146.67px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">When we observe the </span><span class="c2 c11">PriestAttack </span><span class="c2">function we notice that regardless of what happens the </span><span class="c2 c11">Dragon</span><span class="c7 c2">&nbsp;struct is freed. &nbsp;However if the game is won we see the following:</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 237.33px;"><img alt="" src="images/image14.png" style="width: 624.00px; height: 237.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span class="c2">At first I thought it was re mallocing another </span><span class="c2 c11">Dragon </span><span class="c2">struct but instead it is actually mallocing for the players name. &nbsp;This means that even though the </span><span class="c2 c11">Dragon </span><span class="c2">struct was freed in the </span><span class="c2 c11">PriestAttack </span><span class="c7 c2">function the program is still using the struct. &nbsp;This combination of events introduces a use after free vulnerability. &nbsp; &nbsp;</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 104.00px;"><img alt="" src="images/image18.jpg" style="width: 624.00px; height: 104.00px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c2">&nbsp;By inserting the location of what line we want executed as the player name we can call whatever part of the code we want. &nbsp;In particular we want access to the shell that was found in</span><span class="c2 c11">&nbsp;SecretLevel</span><span class="c2">. &nbsp;We are going to need write some clever python in order to exploit this so I will use a CTF optimized library called pwntools (</span><span class="c2 c20"><a class="c1" href="https://www.google.com/url?q=https://pwntools.readthedocs.io/en/2.2/about.html&amp;sa=D&amp;ust=1570727845055000">https://pwntools.readthedocs.io/en/2.2/about.html</a></span><span class="c7 c2">) to write a quick exploit.</span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0 c4"><span class="c7 c2"></span></p><p class="c0"><span style="overflow: hidden; display: inline-block; margin: 0.00px 0.00px; border: 0.00px solid #000000; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px); width: 624.00px; height: 313.33px;"><img alt="" src="images/image7.png" style="width: 624.00px; height: 313.33px; margin-left: 0.00px; margin-top: 0.00px; transform: rotate(0.00rad) translateZ(0px); -webkit-transform: rotate(0.00rad) translateZ(0px);" title=""></span></p><p class="c0"><span class="c2">In this script we first connect to the</span><span class="c2 c11">&nbsp;pwnable.kr</span><span class="c2">&nbsp;site. &nbsp;Then we proc the event for the mother dragon by spamming ones. &nbsp;Then we defeat the mother dragon by overflowing the integer. &nbsp;Once we the dragon is defeated we send the location of the </span><span class="c2 c11">SecretLevel</span><span class="c7 c2">&nbsp;function call to a shell and proceed to make it interactive. &nbsp;</span></p><h2 class="c15" id="h.tb0nayq6v9z5"><span>Conclusion</span></h2><p class="c0"><span class="c2">&nbsp;While this post only covered a couple of vulnerabilities, exploits, and strategies I hope that it still produced a useful starting point for those entering the field of binary exploitation. &nbsp;We discovered that it is important to layout a malleable plan of exploration when working with a binary as this will provide structure to the overall discovery process. &nbsp;As you traverse the binary you will learn new things which will cause you to think differently about the overall problem and potentially modify your plan. &nbsp;It is also important to have a good understanding of how the binary was first engineered by writing what you believe the source code may have looked like. &nbsp;This will allow you to visualize the problem more thoroughly and quickly spot locations that may produce vulnerabilities that you can exploit. &nbsp;As a final bit of advice I encourage newcomers to be patient and take the harder route to the solution. &nbsp;While it may be tempting to quickly look up a solution to the entirety of a problem, you will surely learn more by struggling and exploring all of the crevices that surround the issue.</span></p><p class="c10 c4"><span class="c7 c17"></span></p><p class="c10 c4"><span class="c7 c17"></span></p></body></html>